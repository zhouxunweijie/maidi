<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns:ng="needed for ng: namespace" id="ng-app" ng-app="mdApp">
<head>
    <meta name="renderer" content="webkit|ie-stand|ie-comp" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>搜索</title>
    <link rel="stylesheet" type="text/css" href="../css/find.css">
    <link rel="stylesheet" type="text/css" href="../css/app.css">
    <script type="text/javascript" src="../js/city.js"></script>
</head>
<body ng-controller="searchCtl">
    <div class="find">
        <div class="find-search">
            <div class="area" id="zone">
                <div id="zone-wrap">
                    全国</div>
                <img class="zone-img" src="../img/xia.jpg" />
                <ul id="zone-list">
                </ul>
            </div>
            <div class="search-wraper">
                <div class="wraper">
                    <div class="tab-wraper">
                        <div class="tab icon-tag">
                            <ul class="triggers">
                                <li class="trigger selected" data-type="shop">企业</li>
                                <li class="trigger" data-type="app">用户</li>
                            </ul>
                            <span class="icon-arrow"></span>
                        </div>
                    </div>
                    <div class="inputs">
                        <input type="text" name="q" class="search-combobox-input" placeholder="请输入要搜索的关键词"
                            value="" id="int" />
                    </div>
                </div>
            </div>
        <!--    <input type="text" value="" placeholder="请输入企业迈迪通号/名称" id="int" />-->
            <input type="button" value="查找" id="btnSearch" />
        </div>
        <div class="find-wrap">
            <div class="find-wrap-left">
                <ul class="find-wrap-left-list" id="list">
                    <li class="find-wrap-list">
                        <h5>
                            <img src="../img/li1.png" />配件</h5>
                        <p class="find-wrap-type">
                            <span><a attrpath="1_4" attrid="4" class="click">气动元件</a></span> <span><a attrid="5"
                                attrpath="1_5" class="click">液压元件</a></span> <span><a attrpath="1_7" attrid="7" class="click">
                                    电机</a></span> <span><a attrpath="1_9" attrid="9" class="click">泵类</a></span>
                        </p>
                        <div class="find-pro-list">
                            <a attrid="{{x.cid}}" attrpath="{{x.cpath}}" class="click" ng-repeat="x in ds.accessoriesChilds track  by $index"
                                ng-bind="x.cname"></a>
                        </div>
                    </li>
                    <li class="find-wrap-list" style="display: none;">
                        <h5>
                            <img src="../img/li5.jpg" />二手闲置</h5>
                        <p class="find-wrap-type">
                            <span>铸造机械</span><span>模具机械</span><span>办公设备</span>
                        </p>
                        <div class="find-pro-list">
                            <a href="#" ng-repeat="x in ds.accessoriesChilds track  by $index" ng-bind="x.cname">
                            </a>
                        </div>
                    </li>
                    <li class="find-wrap-list">
                        <h5>
                            <img src="../img/li3.png" />主机</h5>
                        <p class="find-wrap-type">
                            <span><a attrid="64" attrpath="2_64" class="click">机床设备</a></span> <span><a attrid="68"
                                attrpath="2_68" class="click">包装机械</a></span> <span><a attrid="69" attrpath="2_69"
                                    class="click">食品机械</a></span>
                        </p>
                        <div class="find-pro-list">
                            <a attrid="{{x.cid}}" attrpath="{{x.cpath}}" class="click" ng-repeat="x in ds.hostChilds track  by $index"
                                ng-bind="x.cname"></a>
                        </div>
                    </li>
                    <li class="find-wrap-list">
                        <h5>
                            <img src="../img/li4.jpg" />外协</h5>
                        <p class="find-wrap-type">
                            <span><a attrid="341" attrpath="3_341" class="click">抛光</a></span> <span><a attrid="342"
                                attrpath="3_342" class="click">电镀</a></span> <span><a attrid="343" attrpath="3_343"
                                    class="click">喷涂</a></span> <span><a attrid="345" attrpath="3_345" class="click">丝印</a></span>
                            <span><a attrid="347" attrpath="3_347" class="click">雕刻</a></span>
                        </p>
                        <div class="find-pro-list">
                            <a attrid="{{x.cid}}" attrpath="{{x.cpath}}" class="click" ng-repeat="x in ds.outsideChilds track  by $index"
                                ng-bind="x.cname"></a>
                        </div>
                    </li>
                    <li class="find-wrap-list">
                        <h5>
                            <img src="../img/li2.png" />专用配件</h5>
                        <p class="find-wrap-type">
                            <span><a attrid="406" attrpath="1_406" type="1" class="click">纺织机械</a></span> <span>
                                <a attrid="407" attrpath="1_407" type="1" class="click">铸造机械</a></span> <span><a
                                    attrid="408" attrpath="1_408" type="1" class="click">农业机械</a></span>
                        </p>
                        <div class="find-pro-list">
                            <a attrid="{{x.IndID}}" attrpath="{{x.IndPath}}" type="1" class="click" ng-repeat="x in ds.specialChilds track  by $index"
                                ng-bind="x.IndName"></a>
                        </div>
                    </li>
                </ul>
                <div class="find-wrap-left-bot">
                    <img src="../img/net.png" /></div>
            </div>
            <div class="find-wrap-right">
                <h6>
                    推荐企业</h6>
                <div class="right-pro">

                    <a ng-href="{{one.url}}" ng-repeat="one in ds.popComps track  by $index" ng-init="GetCompLog(one)" target="_blank">
                        <img ng-src="{{one.compLogo}}" />
                    </a>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<!--[if lte IE 8]>
        <script>
            document.createElement('ng-include');
            document.createElement('ng-pluralize');
            document.createElement('ng-view');

            // Optionally these for CSS
            document.createElement('ng:include');
            document.createElement('ng:pluralize');
            document.createElement('ng:view');
        </script>
    <![endif]-->
<script type="text/javascript" src="../js/angular.min.js"></script>
<script type="text/javascript" src="../js/jquery-1.8.0.min.js"></script>
<script src="../js/app.js" type="text/javascript"></script>
<script type="text/javascript" src="../js/json2.js"></script>
<script type="text/javascript" src="http://g.maidiyun.com/js/jquery.cookies.js"></script>
<script type="text/javascript" src="http://g.maidiyun.com/js/jquery.base64.js"></script>
<script type="text/javascript" src="http://g.maidiyun.com/js/v3/global.js"></script>

<script>
    var mdApp = angular.module('mdApp', []).config(function ($sceProvider, $httpProvider) {
        // Completely disable SCE to support IE7.
        $sceProvider.enabled(false);
    });
</script>
<script type="text/javascript">    
    var ds = {};
    var header = {
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        }
    };
    mdApp.controller("searchCtl", function ($scope, $http) {
        ds.http = $http;
        ds.scope = $scope;
        ds.popComps = []; //企业对象
        ds.accessoriesChilds = []; //配件
        ds.hostChilds = []; //主机
        ds.outsideChilds = []; //外协
        ds.specialChilds = []; //专用
        $scope.ds = ds;

        $scope.GetCompLog = function (obj) {
            obj.compLogo = "http://pic.maidiyun.com/Y29tcC9sb2dv_" + obj.compid + "_121x53.jpg";
            var domain = obj.domain != "" ? obj.domain : "shop"+obj.compid;
            obj.url = "http://"+domain + ".maidiyun.com";
        };
        popComps(); //加载推广企业
        getChilds();
    });
    var popComps = function () {
        var url = MDApp.url.api + "/app/popcomps";
        var data = {};
        MDLoadData(ds.scope, ds.http, url, data, function () {
            if (data.source.State > 0) {
                ds.popComps = data.source.Data;
            }
        }, 1)
    };



    var getChilds = function () {
        //配件
        var url = MDApp.url.api + "/pkg/childclass?id=1";
        var data1 = {};
        MDLoadData(ds.scope, ds.http, url, data1, function () {
            if (data1.source.State > 0) {
                ds.accessoriesChilds = data1.source.Data;
            }
        }, 1);

        //主机
        var hostUrl = MDApp.url.api + "/pkg/childclass?id=2";
        var data2 = {};
        MDLoadData(ds.scope, ds.http, hostUrl, data2, function () {
            if (data2.source.State > 0) {
                ds.hostChilds = data2.source.Data;
            }
        }, 1);

        //外协
        var outsideUrl = MDApp.url.api + "/pkg/childclass?id=3";
        var data3 = {};
        MDLoadData(ds.scope, ds.http, outsideUrl, data3, function () {
            if (data3.source.State > 0) {
                ds.outsideChilds = data3.source.Data;
            }
        }, 1);

        var speciaUrl = MDApp.url.api + "/basic/industry?pid=1";
        var data4 = {};
        MDLoadData(ds.scope, ds.http, speciaUrl, data4, function () {
            if (data4.source.State > 0) {
                ds.specialChilds = data4.source.Rows;
            }
        }, 1);
    };
    $(function () {
        $(document).on("click", '.click', function () {
            var id = $(this).attr("attrID");
            var path = $(this).attr("attrpath");
            var type = $(this).attr("type");
            var name = $(this).text();
            window.location.href = "return.html?type=1&cid=" + id + "&itype=" + type + "&cpath=" + path + "&name=" + encodeURIComponent(name) + "&city=" + encodeURIComponent($("#zone-wrap").text()) + "&ctype=shop&q=";
        });

        $("#btnSearch").click(function () {
            var cType = $(".search-wraper li.trigger:eq(0)").attr("data-type");
            var searchTxt = $("#int").val();
            searchTxt = searchTxt == undefined ? "" : searchTxt;
            window.location.href = "return.html?q=" + encodeURIComponent(searchTxt) + "&city=" + encodeURIComponent($("#zone-wrap").text()) + "&ctype=" + cType;
        });

        $(".search-wraper li.trigger:not(.selected)").click(function () {
            var prevLi = $(this).prev("li");
            var ctext = $(this).html(), ctype = $(this).attr("data-type");
            $(".search-wraper input[name=app]").val(ctype);
            $(this).html(prevLi.html()).attr("data-type", prevLi.attr("data-type"));
            prevLi.html(ctext).attr("data-type", ctype);
        });

        //        $("#int").keydown(function (e) {
        //            if (e.keyCode == 13) {
        //                $("#btnSearch").click();
        //            }
        //        });

        document.onkeydown = function (ev) {
            var ev = document.all ? window.event : ev;
            if (ev.keyCode == 13) {
                $("#btnSearch").click();
            }
        };
    });

    function MDLoadData(scope, http, url, source, callback, type) {
        //MDloadding.show();
        if ($.browser.msie && ($.browser.version == "7.0" || $.browser.version == "8.0" || $.browser.version == "9.0") && window.XDomainRequest) {
             //Use Microsoft XDR
            var xdr = new XDomainRequest();
            xdr.open("get", url);
            xdr.onload = function () {
                //MDloadding.hide();

                var data = JSON.parse(xdr.responseText);

                if (type != undefined) {
                    if (type == 1) {
                        source.source = data;

                        if (callback != undefined && callback != null) {
                            callback();
                        }
                    } else {
                        source.Rows = data.Data.Rows;
                        source.Total = data.Data.TotalCount;

                        if (callback != undefined) {
                            callback();
                        }
                    }

                } else {
                    if (data.State > 0) {
                        source.source = data.Data;

                        if (callback != undefined && callback != null) {
                            callback();
                        }

                    } else {
                        if (callback != undefined && callback != null) {
                            callback();
                        }

                        if (data.Message != null) {
                            layer.msg(data.Message, { icon: 0, time: 850 });
                        }
                    }
                }
                scope.$apply();
            };
            xdr.onprogress = function () { };
            xdr.ontimeout = function () {

                if (callback != undefined && callback != null) {
                    callback();
                }
                //MDloadding.hide();
            };
            xdr.onerror = function () {

                if (callback != undefined && callback != null) {
                    callback();
                }
                //MDloadding.hide();
            };
            setTimeout(function () {
                xdr.send();
            }, 0);
        } else {


            ds.http.get(url, header).success(function (data) {
               //MDloadding.hide();
                if (type != undefined) {
                    if (type == 1) {
                        source.source = data;
                        if (callback != undefined && callback != null) {
                            callback();
                        }
                    } else {
                        source.Rows = data.Data.Rows;
                        source.Total = data.Data.TotalCount;
                        if (callback != undefined) {
                            callback();
                        }
                    }

                } else {
                    if (data.State > 0) {
                        source.source = data.Data;
                        if (callback != undefined && callback != null) {
                            callback();
                        }

                    } else {
                        if (callback != undefined && callback != null) {
                            callback();
                        }

                        if (data.Message != null) {
                            layer.msg(data.Message, { icon: 0, time: 850 });
                        }
                    }
                }

            })
            .error(function (data) {
                if (callback != undefined && callback != null) {
                    callback();
                }
                //MDloadding.hide();
                layer.msg("加载信息失败！", { icon: 2, time: 800 });
            });
        }
    }
</script>
<script type="text/javascript">
    window.onload = function () {
        var oUl = document.getElementById('list');
        var arrLi = oUl.getElementsByTagName('li');

        for (var i = 0; i < arrLi.length; i++) {
            arrLi[i].onmouseover = function () {
                this.getElementsByTagName('div')[0].style.display = 'block';
            }
            arrLi[i].onmouseout = function () {
                this.getElementsByTagName('div')[0].style.display = 'none';
            }
        }
        //地区
        var oZone = document.getElementById('zone');
        var oList = document.getElementById('zone-list');
        var aSpan = oList.getElementsByTagName('span');
        var aLi = oList.getElementsByTagName('li');
        var oDi = document.getElementById('zone-wrap');
        var html1 = '<li class="zone-te">';
        var html2 = '';
        var onOff = true;
        var isAll = true;
        var num = 0;
        for (key in cityData) {
            var boo = false;
            var cityHtml = '<dl class="zone-city"><dd>';
            //判断是否是直辖市
            for (keys in cityData[key]) {
                if (key == keys) {
                    if (isAll) {
                        isAll = false;
                        html1 += '<span>全国</span>';
                    }
                    html1 += '<span>' + key + '</span>';
                    boo = true;
                    break;
                } else {
                    cityHtml += '<span>' + keys + '</span>';
                }
            }
            if (!boo) {
                html2 += '<li class="zone-province"><strong>' + key + '</strong>' + cityHtml + '</dd></dl></li>';
            }
        }
        oList.innerHTML = html1 + "</li>" + html2;
        oDi.innerHTML = '全国';
        for (var i = 0; i < aSpan.length; i++) {
            aSpan[i].onclick = function () {
                oDi.innerHTML = this.innerHTML;
                oList.style.display = 'none';
            }
        }
        for (var i = 0; i < aLi.length; i++) {
            aLi[i].onmouseover = function () {
                this.style.zIndex = "1";
                this.getElementsByTagName('dl')[0].style.display = 'block';
                this.getElementsByTagName('strong')[0].style.zIndex = num--;
                this.getElementsByTagName('dl')[0].style.zIndex = num++;
            }
            aLi[i].onmouseout = function () {
                this.getElementsByTagName('dl')[0].style.display = 'none';
                this.getElementsByTagName('dl')[0].style.zIndex = 0;
                this.style.zIndex = "0";
            }
        }

        oZone.onclick = function (ev) {
            var ev = ev || event;
            if (onOff) {
                oList.style.display = 'block';
                onOff = false;
            } else {
                oList.style.display = 'none';
                onOff = true;
            }
            ev.cancelBubble = true;
        }
        document.onclick = function () {
            oList.style.display = 'none';
        }
        function getByClass(oParent, sClass) {
            var arr = [];
            var aEle = oParent.getElementsByTagName('*');
            var re = new RegExp('\\b' + sClass + '\\b');
            for (var i = 0; i < aEle.length; i++) {
                if (re.test(aEle[i].className)) {
                    arr.push(aEle[i]);
                }
            }
            return arr;
        }

    };
    function writeuser(data) {
        data = JSON.parse(data);
        user.writeAndChangeTitle(data);
    };
</script>
